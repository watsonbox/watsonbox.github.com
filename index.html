
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Watsonbox</title>
  <meta name="author" content="Howard Wilson">

  
  <meta name="description" content="pocketsphinx-ruby is a high-level Ruby wrapper for the pocketsphinx C API. It uses the Ruby Foreign Function Interface (FFI) to directly load and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://watsonbox.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Watsonbox" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript">
  document.base_document_write = document.write;

  document.write = function(html) {
    if (html.match(/^<link rel="stylesheet".+gist\.github\.com\/assets\/embed.*/) == null) {
      document.base_document_write(html);
    }
  }
</script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31898875-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Watsonbox</a></h1>
  
    <h2>Developer's notes.</h2>
  
</hgroup>

<a href="https://github.com/watsonbox"><img style="position: absolute; top: 0; right: 0; border: 0; width: 120px; height: 120px" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:watsonbox.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/categories/ruby">Ruby</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/watsonbox/cv/blob/master/cv.pdf?raw=true">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/24/ruby-speech-recognition-with-pocketsphinx/">Ruby Speech Recognition With Pocketsphinx</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-24T15:42:02+02:00" pubdate data-updated="true">Oct 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/watsonbox/pocketsphinx-ruby">pocketsphinx-ruby</a> is a high-level Ruby wrapper for the pocketsphinx C API. It uses the Ruby Foreign Function Interface (FFI) to directly load and call functions in libpocketsphinx, as well as libsphinxav for recoding live audio using a number of different audio backends.</p>

<p>The goal of the project is to make it as easy as possible for the Ruby community to experiment with speech recognition, in particular for use in grammar-based command and control applications. Setting up a real time recognizer is as simple as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">configuration</span> <span class="o">=</span> <span class="ss">Pocketsphinx</span><span class="p">:</span><span class="ss">:Configuration</span><span class="o">::</span><span class="no">Grammar</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">sentence</span> <span class="s2">&quot;Go forward ten meters&quot;</span>
</span><span class='line'>  <span class="n">sentence</span> <span class="s2">&quot;Go backward ten meters&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Pocketsphinx</span><span class="p">:</span><span class="ss">:LiveSpeechRecognizer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span><span class="o">.</span><span class="n">recognize</span> <span class="k">do</span> <span class="o">|</span><span class="n">speech</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">speech</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This library supports Ruby MRI 1.9.3+, JRuby, and Rubinius. It depends on the current development versions of Pocketsphinx and Sphinxbase &ndash; there are <a href="https://github.com/watsonbox/homebrew-cmu-sphinx">Homebrew recipes</a> available for a quick start on OSX.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/22/mean-dot-io-on-dokku/">Mean.io on Dokku</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-22T12:32:41+02:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&rsquo;s how I set up the <a href="http://mean.io/">Mean.io</a> stack for deployment with <a href="https://github.com/progrium/dokku">Dokku</a>.</p>

<ul>
<li>Set up MongoDB on the Dokku host and create a database. I used Jeff Utter&rsquo;s single container <a href="https://github.com/jeffutter/dokku-mongodb-plugin">plugin</a> for this.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>dokku mongodb:start
</span><span class='line'><span class="nv">$ </span>dokku mongodb:create &lt;app&gt; &lt;database&gt;
</span><span class='line'><span class="nv">$ </span>dokku mongodb:link &lt;app&gt; &lt;database&gt;
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Modify <code>config/env/production.js</code> to use ENV var for MongoDB URL:</li>
</ul>


<figure class='code'><figcaption><span>config/env/production.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGO_URL</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// [REST OF FILE ELIDED]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Configure the application to run in the production environment:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>dokku config:set &lt;app&gt; <span class="nv">NODE_ENV</span><span class="o">=</span>production
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Set the unsafe-perm npm configuration option to allow npm to operate under the root account. More information <a href="https://github.com/progrium/dokku/wiki/Troubleshooting">here</a>. Create <code>.npmrc</code> as follows:</li>
</ul>


<figure class='code'><figcaption><span>.npmrc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>unsafe-perm <span class="o">=</span> <span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Configure a <a href="https://github.com/mbuchetics/heroku-buildpack-nodejs-grunt">buildpack which supports Grunt</a> in <code>.env</code>:</li>
</ul>


<figure class='code'><figcaption><span>.env</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">BUILDPACK_URL</span><span class="o">=</span>https://github.com/mbuchetics/heroku-buildpack-nodejs-grunt.git
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Add Heroku build task without environment to <code>Gruntfile.js</code> since Dokku doesn&rsquo;t read config during build steps:</li>
</ul>


<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="c1">// [REST OF FILE ELIDED]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// For Heroku users only.</span>
</span><span class='line'>  <span class="c1">// Docs: https://github.com/linnovate/mean/wiki/Deploying-on-Heroku</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;heroku:production&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cssmin&#39;</span><span class="p">,</span> <span class="s1">&#39;uglify&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dokku does not set ENV vars during build steps:</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;heroku:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cssmin&#39;</span><span class="p">,</span> <span class="s1">&#39;uglify&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/31/getting-started-with-dokku/">Getting Started With Dokku</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-31T14:35:02+02:00" pubdate data-updated="true">Aug 31<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>UPDATE: Some recent changes to <a href="https://github.com/ohardy/dokku-mariadb">ohardy/dokku-mariadb</a> have resolved the problems with losing DB links on reboot.</em></p>

<p>I decided to jump in and set up my own mini-Heroku with <a href="https://www.docker.com/">Docker</a> and <a href="https://github.com/progrium/dokku">Dokku</a> as seems to be the fashion at the moment. Here are my thoughts and a few of the issues I hit along the way. Using Dokku v0.2.3.</p>

<p>I <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-dokku-application">installed Dokku on Digital Ocean</a>. It doesn&rsquo;t have to be Digital Ocean but they certainly make it easy. Then <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">added some swap space</a>, too. Save some typing by setting up an alias:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">alias </span><span class="nv">dokku</span><span class="o">=</span><span class="err">&#39;</span>ssh -t dokku@yourvps.tld
</span></code></pre></td></tr></table></div></figure>


<h2>Configuration Variables</h2>

<p>Dokku allows applications to be configured using enviornment variables as described in the twelve-factor app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>dokku config:set acme <span class="nv">company_name</span><span class="o">=</span><span class="s2">&quot;Acme Corporation&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That won&rsquo;t work though, because Dokku&rsquo;s command line app <a href="https://github.com/progrium/dokku/issues/482">doesn&rsquo;t support spaces in config variables</a>. You can get around this by setting the configuration directly in <code>/home/dokku/acme/ENV</code>:</p>

<figure class='code'><figcaption><span>/home/dokku/acme/ENV</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">company_name</span><span class="o">=</span><span class="s2">&quot;Acme Corporation&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>They won&rsquo;t be correctly reported by <code>dokku config acme</code>, but they&rsquo;ll work.</p>

<h2>Configuration Backup</h2>

<p>You can backup Dokku&rsquo;s configuration (including application configuration) with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>dokku backup:export <span class="o">[</span>FILE<span class="o">]</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will place the backup in <code>/home/dokku/[FILE]</code>.</p>

<h2>Multiple Domains and Basic Auth</h2>

<p>I installed a couple of plugins which worked well out of the box:</p>

<p><a href="https://github.com/matto1990/dokku-secure-apps">https://github.com/matto1990/dokku-secure-apps</a><br/>Secures an individual app with HTTP Basic authentication. Dead simple to use and useful when deploying apps for testing or private use only.</p>

<p><a href="https://github.com/neam/dokku-custom-domains">https://github.com/neam/dokku-custom-domains</a><br/>Configure additional custom domains for your dokku app.</p>

<h2>Persistent Storage</h2>

<p>Dokku has plenty of <a href="https://github.com/progrium/dokku/wiki/Plugins#datastores">plugins for different data stores</a>. I decided to work with <a href="https://github.com/ohardy/dokku-mariadb">ohardy/dokku-mariadb</a> since on a VPS with farily limited memory, I preferred to only run one container and a single instance of MariaDB.</p>

<p>The main problem I faced here was keeping database connections working after a reboot. On reboot, docker containers are restarted and will receive a new private IP. This means that the <code>DATABASE_URL</code> used by the apps, e.g. <code>mysql://[PRIVATE_IP]:3306/[database]</code> will change and break database connections. Despite some <a href="https://github.com/Kloadut/dokku-pg-plugin/issues/12">discussion</a> and <a href="https://github.com/Kloadut/dokku-md-plugin/commit/de26c1e10f1e30c059ae827fff65b4a132ccc2ed">attempted fixes</a>, the multiple container dokku MariaDB plugin (<a href="https://github.com/Kloadut/dokku-md-plugin">kloadut/dokku-md-plugin</a>) uses a dynamic port for each container, which also changes on reboot, so suffers from the same problem.</p>

<p>I fixed this issue in <a href="https://github.com/watsonbox/dokku-mariadb/commit/ab724e99f49968695da3a0ce09fe7582bf735328">watsonbox/dokku-mariadb:reboot-persist-connections</a> by patching ohardy/dokku-mariadb to use a fixed IP address. It also uses a fixed port (3306), since only one container/instance is created.</p>

<p>Worth noting that ohardy/dokku-mariadb stores persistent DB data on the host in <code>/home/dokku/.o_mariadb</code> (kloadut/dokku-md-plugin in <code>/home/dokku/.mariadb</code>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/23/aggregation-for-ember-data-async-relationships/">Aggregation for Ember Data Async Relationships</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-23T17:12:21+02:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ember.js has <a href="http://emberjs.com/guides/object-model/computed-properties-and-aggregate-data/">computed properties</a> for aggregating data which are automatically re-calculated when the source data set changes. But what if we want to display aggregate data from an async relationship in a list view? We might have the following:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/models/invoice.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">App.Invoice = </span><span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">lineItems: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s">&#39;lineItem&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">async: </span><span class="kc">true</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">lineItemAmounts: </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">.</span><span class="nx">mapBy</span><span class="p">(</span><span class="s">&#39;lineItems&#39;</span><span class="p">,</span> <span class="s">&#39;amount&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">amount: </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="s">&#39;lineItemAmounts&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each <code>App.Invoice</code> has a bunch of <code>App.LineItem</code>s, and calculates its own amount by summing up their individual amounts. However, each time an invoice is rendered, all of the line items will be fetched from the server in order to make this calculation.</p>

<p>What we can do instead is send the aggregate figure from the server along with the invoice. It might be calculated on the fly (with a <code>group by</code> query, for example), or maintained along with the invoice. Here&rsquo;s an approach that does exactly this, but will switch to using the real ember data objects once they have been loaded:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/models/invoice.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">App.Invoice = </span><span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">subtotal: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;number&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">lineItems: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s">&#39;lineItem&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">async: </span><span class="kc">true</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">lineItemAmounts: </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">.</span><span class="nx">mapBy</span><span class="p">(</span><span class="s">&#39;lineItems&#39;</span><span class="p">,</span> <span class="s">&#39;amount&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">lineItemAmountsSum: </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="s">&#39;lineItemAmounts&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Uses subtotal until async lineItems become available</span>
</span><span class='line'>  <span class="nv">amount: </span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">@cacheFor</span><span class="p">(</span><span class="s">&#39;lineItems&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;lineItemAmountsSum&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;subtotal&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">property</span><span class="p">(</span><span class="s">&#39;lineItems.@each.amount&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case <code>subtotal</code> is the aggregated amount from the server.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/13/lazy-and-partial-data-loading-with-ember-dot-js-and-rails/">Lazy and Partial Data Loading With Ember.js and Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-13T14:43:13+02:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While learning <a href="http://emberjs.com/">Ember.js</a>, I couldn&rsquo;t find all the info laid out clearly in one place on these subjects, so thought I&rsquo;d write up my findings. I&rsquo;m using Ember.js 1.5.1, Ember Data 1.0.0-beta.7+canary.f482da04 (!!), and Rails 4.1.0.</p>

<h2>Lazy Loading Relationships</h2>

<p>Most of the <a href="http://emberjs.com/api/data/classes/DS.ActiveModelSerializer.html">Rails/Ember guidelines</a> out there suggest that related data should normally be sideloaded, which is great and helps reduce the number of HTTP requests required, or data duplication (in the case of embedded data). To sideload data, set up the relationship and Rails serializer as follows:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/models/project.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">App.Project = </span><span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">name: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">description: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">invoices: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s">&#39;invoice&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/serializers/project_serializer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProjectSerializer</span> <span class="o">&lt;</span> <span class="ss">ActiveModel</span><span class="p">:</span><span class="ss">:Serializer</span>
</span><span class='line'>  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:invoices</span><span class="p">,</span> <span class="ss">embed</span><span class="p">:</span> <span class="ss">:ids</span><span class="p">,</span> <span class="kp">include</span><span class="p">:</span> <span class="kp">true</span> <span class="c1"># Sideload relationship</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Example JSON Response</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;projects&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Project 1&quot;</span><span class="p">,</span> <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="nt">&quot;invoice_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;invoices&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;INV-002&quot;</span><span class="p">,</span> <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-06-11&quot;</span><span class="p">,</span> <span class="nt">&quot;project_id&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;INV-001&quot;</span><span class="p">,</span> <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-04-04&quot;</span><span class="p">,</span> <span class="nt">&quot;project_id&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Async Loading</h3>

<p>Often we&rsquo;d prefer to lazily load the associated data only when it&rsquo;s referenced. Ember Data calls this an async relationship. Simply modify the above by omitting the <code>include</code> serializer option and adding <code>async</code> to the relationship:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/models/project.js.coffee (partial)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">invoices: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s">&#39;invoice&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">async: </span><span class="kc">true</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/serializers/lazy_project_serializer.rb (partial)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:invoices</span><span class="p">,</span> <span class="ss">embed</span><span class="p">:</span> <span class="ss">:ids</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Example JSON Response</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;projects&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Project 1&quot;</span><span class="p">,</span> <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="nt">&quot;invoice_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the <code>invoices</code> relationship is accessed, Ember Data will automatically make a request to <code>/invoices?ids[]=1&amp;ids[]=2</code> (or presumably wherever that route is defined), so the Rails <code>InvoicesController</code> must be set up to restrict returned data based on the <code>ids</code> parameter.</p>

<p><em>Update 30/12/14: Since Ember Data v1.0.0-beta.9 <a href="http://emberjs.com/blog/2014/08/18/ember-data-1-0-beta-9-released.html">has many coalescing has become opt-in</a>. This means setting <code>coalesceFindRequests: true</code> on the REST adapter for the above behavior. Thanks to CamonZ for pointing this out.</em></p>

<p>Note that if an association is set to <code>async</code>, but sideloaded data exists in the server response, Ember Data will simply use that data and not attempt to make another request. This is useful, allowing data to be sideloaded for a detail view because we know we&rsquo;re going to need it, but not for a list view where it might not be used. When moving from list to detail, the invoices will be loaded, but when arriving directly on the detail page, only the project will be loaded. Specify a different serializer in Rails for each action:</p>

<figure class='code'><figcaption><span>app/controllers/projects_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProjectsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:json</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="n">respond_with</span> <span class="no">Project</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">each_serializer</span><span class="p">:</span> <span class="no">LazyProjectSerializer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="n">respond_with</span> <span class="no">Project</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Async Loading From Links</h3>

<p>Another possibility, which gives more control over association endpoints, and avoids having to pass a bunch of IDs around, is to provide links for the relationships in the JSON response. For example:</p>

<figure class='code'><figcaption><span>app/serializers/project_serializer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProjectSerializer</span> <span class="o">&lt;</span> <span class="ss">ActiveModel</span><span class="p">:</span><span class="ss">:Serializer</span>
</span><span class='line'>  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:links</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">links</span>
</span><span class='line'>    <span class="p">{</span> <span class="ss">invoices</span><span class="p">:</span> <span class="n">project_invoices_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Loading Partial Models</h2>

<p>Imagine that we have a dropdown list of projects in the page navbar. In addition to lazy loading related data, we might also want to omit attributes we know we&rsquo;re not going to need yet. In this case a large project description might be a candidate for ommission from the list view, especially if the list of projects is large. The most comprehensive description of this problem I was able to find is <a href="http://discuss.emberjs.com/t/loading-partial-models-then-filling-them-with-ember-data/819">here</a>, and includes links to related discussions.</p>

<p>Firstly we need to identify the list data as partial by adding a <code>partial</code> attribute and setting it in a <code>PartialProjectSerializer</code>. We also ommit the invoices and description:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/models/project.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">App.Project = </span><span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">name: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">description: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">partial: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;boolean&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">invoices: </span><span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s">&#39;invoice&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">async: </span><span class="kc">true</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/serializers/partial_project_serializer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PartialProjectSerializer</span> <span class="o">&lt;</span> <span class="no">ApplicationSerializer</span>
</span><span class='line'>  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:partial</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">partial</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We now have two problems to solve:</p>

<ol>
<li>Reload a complete model for the detail view if we have only a partial model.</li>
<li>Don&rsquo;t allow partial list data to overwrite a complete model if it comes in afterwards. You can simulate this in your dev environment using a threaded web server such as Puma and setting a delay on the resource index.</li>
</ol>


<p>For the first we can use <code>setupController</code> on the project route. Modifying the <code>model</code> hook won&rsquo;t work when a model is passed for example to <code>link-to</code> because it <a href="http://emberjs.com/guides/routing/asynchronous-routing/#toc_beforemodel-and-aftermodel">doesn&rsquo;t get called</a>.</p>

<figure class='code'><figcaption><span>app/assets/javascripts/routes/project_route.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">Facture.ProjectRoute = </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">model: </span><span class="nf">(params) -&gt;</span>
</span><span class='line'>    <span class="nx">@store</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;project&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">project_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">setupController: </span><span class="nf">(controller, model) -&gt;</span>
</span><span class='line'>    <span class="c1"># If the model is partial, we&#39;ll refresh it (from the full project resource)</span>
</span><span class='line'>    <span class="nx">model</span><span class="p">.</span><span class="nx">reload</span><span class="p">()</span> <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;partial&#39;</span>
</span><span class='line'>    <span class="nx">controller</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="nx">model</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be nice if we could solve the second problem by asking Ember Data to retrieve and <em>merge</em> data from the server (using something like <code>Store#find_and_update</code>), but that doesn&rsquo;t appear to be possible. It is however possible to update individual records using <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_update"><code>Store#update</code></a>.</p>

<p>I&rsquo;ve been getting these projects in the <code>ApplicationRoute</code>, which now looks like this:</p>

<figure class='code'><figcaption><span>app/assets/javascripts/routes/application.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">Facture.ApplicationRoute = </span><span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">setupController: </span><span class="nf">(controller) -&gt;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span> <span class="s">&#39;/projects.json&#39;</span><span class="p">,</span> <span class="nf">(data) =&gt;</span>
</span><span class='line'>      <span class="c1"># Update records in the store</span>
</span><span class='line'>      <span class="nv">projects = </span><span class="nx">data</span><span class="p">[</span><span class="s">&#39;projects&#39;</span><span class="p">].</span><span class="nx">map</span> <span class="nf">(project) =&gt;</span>
</span><span class='line'>        <span class="c1"># Don&#39;t merge partial=true</span>
</span><span class='line'>        <span class="k">if</span> <span class="nv">existing_project = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">getById</span><span class="p">(</span><span class="s">&#39;project&#39;</span><span class="p">,</span> <span class="nx">project</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">project.partial = </span><span class="kc">false</span> <span class="k">unless</span> <span class="nx">existing_project</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;partial&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">@store</span><span class="p">.</span><span class="nx">update</span> <span class="s">&#39;project&#39;</span><span class="p">,</span> <span class="nx">project</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Set all records on the controller</span>
</span><span class='line'>      <span class="nx">controller</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;projects&#39;</span><span class="p">,</span> <span class="nx">projects</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/25/confreaks-xbmc-addon-0-dot-3-0/">Confreaks XBMC Addon 0.3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-25T12:30:25+01:00" pubdate data-updated="true">Mar 25<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I finally got around to updating <a href="https://github.com/watsonbox/xbmc-confreaks">xbmc-confreaks</a> to work properly with XBMC Frodo and Gotham. This time I&rsquo;ve also submitted it to the official XBMC Addons repository so as of yesterday you should be able to install it through &lsquo;Get Addons&rsquo; in XBMC itself. Be aware that you might need to refresh the repository (right click) first.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/23/fb-canvas-apps-2-fixed-positioning/">FB Canvas Apps #2: Fixed Positioning</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-23T13:32:00+01:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was asked to add a fixed position &lsquo;tab&rsquo; to the left side of a Facebook canvas app, for example like the <a href="https://getsatisfaction.com/">Get Satisfaction</a> &lsquo;Community&rsquo; tab.</p>

<p>Normally this would be a simple case of using <code>position: fixed</code>, but not in this case because Facebook canvas apps live inside iFrames. Facebook resizes this iFrame to fit its content, meaning that the main browser scrollbar is used to scroll around the page rather than the iFrame&rsquo;s scrollbar. However, fixed position elements are fixed relative to the iFrame, not the main document. Since the iFrame never actually scrolls, the fixed element stays put.</p>

<p>The solution is to use a little javascript to scroll the fixed element relative to the Facebook scroll position at a fixed interval. This gives a slightly different user experience but is the best approach I&rsquo;ve found so far.</p>

<figure class='code'><figcaption><span>CoffeeScript/jQuery: pseudoFixed Method and Invocation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">$.fn.pseudoFixed = </span><span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nv">top = </span><span class="k">this</span><span class="p">.</span><span class="nx">position</span><span class="p">().</span><span class="nx">top</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span>
</span><span class='line'>    <span class="o">=&gt;</span> <span class="nx">FB</span><span class="p">.</span><span class="nx">Canvas</span><span class="p">.</span><span class="nx">getPageInfo</span><span class="p">(</span><span class="nf">(info) =&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span> <span class="nv">top: </span><span class="nx">info</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+</span> <span class="nx">top</span> <span class="p">})),</span>
</span><span class='line'>    <span class="mi">1000</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s">&#39;[data-behavior~=pseudo-fixed]&#39;</span><span class="p">).</span><span class="nx">pseudoFixed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Example HTML Tab Element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">data-behavior=</span><span class="s">&quot;pseudo-fixed&quot;</span> <span class="na">style=</span><span class="s">&quot;position: fixed; left: 0; top: 150px&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/25/fb-canvas-apps-1-dialog-positioning/">FB Canvas Apps #1: Dialog Positioning</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-25T16:33:00+02:00" pubdate data-updated="true">Sep 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Having worked on several Facebook applications, I&rsquo;ve built up a few tricks to solve some common problems. This one shows how to get a dialog (jQuery UI, in this case) to appear centered in the browser rather than centered in the canvas iFrame.</p>

<p>The problem is caused by Facebook resizing the canvas iFrame to accommodate the entire page. When a dialog is displayed inside the canvas application, it is displayed vertically centered inside that iFrame, which can cause the current browser scroll position to jump up or down accordingly.</p>

<p>The fix is to call Facebook&rsquo;s <a href="http://developers.facebook.com/docs/reference/javascript/FB.Canvas.getPageInfo/"><code>FB.Canvas.getPageInfo</code></a> JS API method, to position the dialog relative to the user&rsquo;s current browser scroll position.</p>

<p>Here is an implementation which uses <a href="http://coffeescript.org/">CoffeeScript</a> and extends the <a href="http://jqueryui.com/demos/dialog/">jQuery UI dialog widget</a>.</p>

<figure class='code'><figcaption><span>Facebook Initialization</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">$</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="c1"># Async Facebook initialisation</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nv">fbAsyncInit = </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">FB</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nv">appId: </span><span class="s">&#39;APP_ID&#39;</span><span class="p">,</span> <span class="nv">status: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">cookie: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">xfbml: </span><span class="kc">true</span> <span class="p">})</span>
</span><span class='line'>    <span class="nx">FB</span><span class="p">.</span><span class="nx">Canvas</span><span class="p">.</span><span class="nx">setAutoGrow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Allows other components to hook into this event with $(document).on(&#39;fb:initialized&#39;, -&gt; ...)</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;fb:initialized&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>The Dialog Widget</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">CanvasDialog =</span>
</span><span class='line'>  <span class="c1"># Some example default dialog options</span>
</span><span class='line'>  <span class="nv">options: </span><span class="p">{</span>
</span><span class='line'>    <span class="nv">width: </span><span class="mi">600</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">modal: </span><span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">autoOpen: </span><span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">_init: </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">@_inCanvas</span>
</span><span class='line'>      <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fbLoaded</span><span class="p">()</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_showDialogInCanvas</span><span class="p">()</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;fb:initialized&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_showDialogInCanvas</span><span class="p">()</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_showDialog</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Displays the dialog positioned correctly inside the FB canvas iFrame</span>
</span><span class='line'>  <span class="nv">_showDialogInCanvas: </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">FB</span><span class="p">.</span><span class="nx">Canvas</span><span class="p">.</span><span class="nx">getPageInfo</span> <span class="nf">(info) =&gt;</span>
</span><span class='line'>      <span class="vi">@options.position = </span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+</span> <span class="mi">50</span><span class="p">]</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_showDialog</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Calls the jQuery UI dialog&#39;s original init method</span>
</span><span class='line'>  <span class="nv">_showDialog: </span><span class="nf">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_init</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># True if dialog is being loading inside the FB iFrame (any iFrame for that matter)</span>
</span><span class='line'>  <span class="nv">_inCanvas: </span><span class="nx">top</span> <span class="o">!=</span> <span class="nx">self</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># True if FB javascript API has been loaded</span>
</span><span class='line'>  <span class="nv">_fbLoaded: </span><span class="nf">-&gt;</span> <span class="k">typeof</span> <span class="nx">FB</span> <span class="o">!=</span> <span class="s">&#39;undefined&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">widget</span> <span class="s">&quot;ui.canvasDialog&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">dialog</span><span class="p">,</span> <span class="nx">CanvasDialog</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Example Usage</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#canvasDialog&#39;</span><span class="p">).</span><span class="nx">canvasDialog</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Notes</h3>

<ul>
<li><p>By triggering an event when Facebook is initialized, the <code>CanvasDialog</code> is able to wait for the Facebook JS API to become available if it has not yet been loaded.</p></li>
<li><p>In development it can be useful to work outside the Facebook environment. The <code>CanvasDialog</code> detects this and shows the dialog without attempting to call the Facebook API.</p></li>
<li><p>In the past I&rsquo;ve often used the excellent and well maintained <a href="http://www.jacklmoore.com/colorbox">ColorBox</a> library for dialogs. I note that it too has been <a href="https://github.com/jackmoore/colorbox/pull/93">updated</a> with similar functionalilty.</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/24/rails-and-php-session-sharing-number-2/">Rails &amp; PHP Session Sharing #2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-24T16:37:00+02:00" pubdate data-updated="true">Jul 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Back in May I <a href="/blog/2012/05/01/sharing-session-between-rails-and-php/">posted</a> on how I set up shared sessions between Rails and a legacy PHP app. Since then I&rsquo;ve upgraded memcache-client to Mike Perham&rsquo;s replacement, <a href="https://github.com/mperham/dalli/">Dalli</a>. I took this opportunity to tidy up the PHP session store as well. Here is what I have now:</p>

<div><script src='https://gist.github.com/3170415.js'></script>
<noscript><pre><code>require 'action_dispatch/middleware/session/dalli_store'

# - PHP side is 5.3.6 configured with session.save_handler = memcache
# - Requires php-serialize gem for serialization: https://github.com/jqr/php-serialize
module ActionDispatch
  module Session
    class PhpDalliStore &lt; ActionDispatch::Session::DalliStore
      require 'php_serialize'

      class PhpSerializingPoolDecorator &lt; SimpleDelegator
        def set(key, value, ttl = nil, options = nil)
          super(key, PHP.serialize_session(value), 0, :raw =&gt; true)
        end

        def get(key, options = nil)
          value = super(key)
          PHP.unserialize(value) if value &amp;&amp; value != ''
        end
      end

      def initialize(app, options = {})
        # Default to no namespace and cookie name matching PHP settings
        super(app, options.merge(:namespace =&gt; nil, :key =&gt; 'PHPSESSID'))

        # Decorate the pool to do some serialization
        @pool = PhpSerializingPoolDecorator.new(@pool)
      end
    end
  end
end</code></pre></noscript></div>


<p>This is cleaner than what I had before and should be much more resistant to changes in Dalli, too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/19/confreaks-xbmc-addon/">Confreaks XBMC Addon</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-19T22:06:00+02:00" pubdate data-updated="true">May 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I wrote a little plugin for watching <a href="http://www.confreaks.com/">Confreaks</a> Ruby presentations in <a href="http://www.xbmc.org/">XBMC</a>.</p>

<p>As luck would have it, Jonathan Beluch has been working on <a href="http://readthedocs.org/projects/xbmcswift2/">xmbcswift2</a> over the last month or so, which he describes as &ldquo;A micro framework to enable rapid development of XBMC plugins&rdquo;. Although the library is still under development, the documentation is very complete.</p>

<p>Check out the xbmc-confreaks <a href="http://github.com/watsonbox/xbmc-confreaks">source</a>, or download the <a href="http://github.com/watsonbox/xbmc-confreaks/raw/master/release/xbmc-confreaks-0.1.zip">zip file</a> ready to be installed directly into XBMC. I&rsquo;ve only tested it with the latest stable release of XBMC 11.0 Eden.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/24/ruby-speech-recognition-with-pocketsphinx/">Ruby Speech Recognition With Pocketsphinx</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/mean-dot-io-on-dokku/">Mean.io on Dokku</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/31/getting-started-with-dokku/">Getting Started With Dokku</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/23/aggregation-for-ember-data-async-relationships/">Aggregation for Ember Data Async Relationships</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/13/lazy-and-partial-data-loading-with-ember-dot-js-and-rails/">Lazy and Partial Data Loading With Ember.js and Rails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/25/confreaks-xbmc-addon-0-dot-3-0/">Confreaks XBMC Addon 0.3.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/23/fb-canvas-apps-2-fixed-positioning/">FB Canvas Apps #2: Fixed Positioning</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/25/fb-canvas-apps-1-dialog-positioning/">FB Canvas Apps #1: Dialog Positioning</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/24/rails-and-php-session-sharing-number-2/">Rails &amp; PHP Session Sharing #2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/19/confreaks-xbmc-addon/">Confreaks XBMC Addon</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/watsonbox">@watsonbox</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'watsonbox',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Howard Wilson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'watsonbox';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
