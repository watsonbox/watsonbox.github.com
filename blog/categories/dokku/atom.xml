<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Dokku | Watsonbox]]></title>
  <link href="http://watsonbox.github.com/blog/categories/dokku/atom.xml" rel="self"/>
  <link href="http://watsonbox.github.com/"/>
  <updated>2015-01-21T20:54:28+01:00</updated>
  <id>http://watsonbox.github.com/</id>
  <author>
    <name><![CDATA[Howard Wilson]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Mean.io on Dokku]]></title>
    <link href="http://watsonbox.github.com/blog/2014/09/22/mean-dot-io-on-dokku/"/>
    <updated>2014-09-22T12:32:41+02:00</updated>
    <id>http://watsonbox.github.com/blog/2014/09/22/mean-dot-io-on-dokku</id>
    <content type="html"><![CDATA[<p>Here&rsquo;s how I set up the <a href="http://mean.io/">Mean.io</a> stack for deployment with <a href="https://github.com/progrium/dokku">Dokku</a>.</p>

<ul>
<li>Set up MongoDB on the Dokku host and create a database. I used Jeff Utter&rsquo;s single container <a href="https://github.com/jeffutter/dokku-mongodb-plugin">plugin</a> for this.</li>
</ul>


<p><code>bash
$ dokku mongodb:start
$ dokku mongodb:create &lt;app&gt; &lt;database&gt;
$ dokku mongodb:link &lt;app&gt; &lt;database&gt;
</code></p>

<ul>
<li>Modify <code>config/env/production.js</code> to use ENV var for MongoDB URL:</li>
</ul>


<p>```js config/env/production.js
&lsquo;use strict&rsquo;;</p>

<p>module.exports = {
  db: process.env.MONGO_URL,</p>

<p>// [REST OF FILE ELIDED]
```</p>

<ul>
<li>Configure the application to run in the production environment:</li>
</ul>


<p><code>bash
$ dokku config:set &lt;app&gt; NODE_ENV=production
</code></p>

<ul>
<li>Set the unsafe-perm npm configuration option to allow npm to operate under the root account. More information <a href="https://github.com/progrium/dokku/wiki/Troubleshooting">here</a>. Create <code>.npmrc</code> as follows:</li>
</ul>


<p><code>bash .npmrc
unsafe-perm = true
</code></p>

<ul>
<li>Configure a <a href="https://github.com/mbuchetics/heroku-buildpack-nodejs-grunt">buildpack which supports Grunt</a> in <code>.env</code>:</li>
</ul>


<p><code>bash .env
BUILDPACK_URL=https://github.com/mbuchetics/heroku-buildpack-nodejs-grunt.git
</code></p>

<ul>
<li>Add Heroku build task without environment to <code>Gruntfile.js</code> since Dokku doesn&rsquo;t read config during build steps:</li>
</ul>


<p>```js Gruntfile.js
  // [REST OF FILE ELIDED]</p>

<p>  // For Heroku users only.
  // Docs: <a href="https://github.com/linnovate/mean/wiki/Deploying-on-Heroku">https://github.com/linnovate/mean/wiki/Deploying-on-Heroku</a>
  grunt.registerTask(&lsquo;heroku:production&rsquo;, [&lsquo;cssmin&rsquo;, &lsquo;uglify&rsquo;]);</p>

<p>  // Dokku does not set ENV vars during build steps:
  grunt.registerTask(&lsquo;heroku:&rsquo;, [&lsquo;cssmin&rsquo;, &lsquo;uglify&rsquo;]);
};
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting Started with Dokku]]></title>
    <link href="http://watsonbox.github.com/blog/2014/08/31/getting-started-with-dokku/"/>
    <updated>2014-08-31T14:35:02+02:00</updated>
    <id>http://watsonbox.github.com/blog/2014/08/31/getting-started-with-dokku</id>
    <content type="html"><![CDATA[<p><em>UPDATE: Some recent changes to <a href="https://github.com/ohardy/dokku-mariadb">ohardy/dokku-mariadb</a> have resolved the problems with losing DB links on reboot.</em></p>

<p>I decided to jump in and set up my own mini-Heroku with <a href="https://www.docker.com/">Docker</a> and <a href="https://github.com/progrium/dokku">Dokku</a> as seems to be the fashion at the moment. Here are my thoughts and a few of the issues I hit along the way. Using Dokku v0.2.3.</p>

<p>I <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-dokku-application">installed Dokku on Digital Ocean</a>. It doesn&rsquo;t have to be Digital Ocean but they certainly make it easy. Then <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">added some swap space</a>, too. Save some typing by setting up an alias:</p>

<p><code>bash
$ alias dokku='ssh -t dokku@yourvps.tld
</code></p>

<h2>Configuration Variables</h2>

<p>Dokku allows applications to be configured using enviornment variables as described in the twelve-factor app:</p>

<p><code>bash
$ dokku config:set acme company_name="Acme Corporation"
</code></p>

<p>That won&rsquo;t work though, because Dokku&rsquo;s command line app <a href="https://github.com/progrium/dokku/issues/482">doesn&rsquo;t support spaces in config variables</a>. You can get around this by setting the configuration directly in <code>/home/dokku/acme/ENV</code>:</p>

<p><code>bash /home/dokku/acme/ENV
export company_name="Acme Corporation"
</code></p>

<p>They won&rsquo;t be correctly reported by <code>dokku config acme</code>, but they&rsquo;ll work.</p>

<h2>Configuration Backup</h2>

<p>You can backup Dokku&rsquo;s configuration (including application configuration) with:</p>

<p><code>bash
$ dokku backup:export [FILE]`
</code></p>

<p>This will place the backup in <code>/home/dokku/[FILE]</code>.</p>

<h2>Multiple Domains and Basic Auth</h2>

<p>I installed a couple of plugins which worked well out of the box:</p>

<p><a href="https://github.com/matto1990/dokku-secure-apps">https://github.com/matto1990/dokku-secure-apps</a><br/>Secures an individual app with HTTP Basic authentication. Dead simple to use and useful when deploying apps for testing or private use only.</p>

<p><a href="https://github.com/neam/dokku-custom-domains">https://github.com/neam/dokku-custom-domains</a><br/>Configure additional custom domains for your dokku app.</p>

<h2>Persistent Storage</h2>

<p>Dokku has plenty of <a href="https://github.com/progrium/dokku/wiki/Plugins#datastores">plugins for different data stores</a>. I decided to work with <a href="https://github.com/ohardy/dokku-mariadb">ohardy/dokku-mariadb</a> since on a VPS with farily limited memory, I preferred to only run one container and a single instance of MariaDB.</p>

<p>The main problem I faced here was keeping database connections working after a reboot. On reboot, docker containers are restarted and will receive a new private IP. This means that the <code>DATABASE_URL</code> used by the apps, e.g. <code>mysql://[PRIVATE_IP]:3306/[database]</code> will change and break database connections. Despite some <a href="https://github.com/Kloadut/dokku-pg-plugin/issues/12">discussion</a> and <a href="https://github.com/Kloadut/dokku-md-plugin/commit/de26c1e10f1e30c059ae827fff65b4a132ccc2ed">attempted fixes</a>, the multiple container dokku MariaDB plugin (<a href="https://github.com/Kloadut/dokku-md-plugin">kloadut/dokku-md-plugin</a>) uses a dynamic port for each container, which also changes on reboot, so suffers from the same problem.</p>

<p>I fixed this issue in <a href="https://github.com/watsonbox/dokku-mariadb/commit/ab724e99f49968695da3a0ce09fe7582bf735328">watsonbox/dokku-mariadb:reboot-persist-connections</a> by patching ohardy/dokku-mariadb to use a fixed IP address. It also uses a fixed port (3306), since only one container/instance is created.</p>

<p>Worth noting that ohardy/dokku-mariadb stores persistent DB data on the host in <code>/home/dokku/.o_mariadb</code> (kloadut/dokku-md-plugin in <code>/home/dokku/.mariadb</code>).</p>
]]></content>
  </entry>
  
</feed>
